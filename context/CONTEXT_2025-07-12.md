# eBay TCG Batch Uploader - Project Context

> **This is the main context file for the eBay TCG Batch Uploader project**  
> Last Updated: July 12, 2025

## Overview

The eBay TCG Batch Uploader is an automated system for processing, identifying, and listing Trading Card Game (TCG) cards on eBay. It uses AI-powered image recognition, multiple pricing APIs, and automated batch processing to streamline the card selling workflow.

This document serves as the main context file, documenting the project structure, recent changes, and key information following a comprehensive reorganization to improve structure, security, performance, and maintainability.

## Recent Updates (July 12, 2025)

### Context Management System
- **Created context directory structure**: Established `context/` directory for organized context management
- **Archived previous context**: Moved CONTEXT.md to `context/archive/CONTEXT_2025-07-11.md`
- **Implemented versioning**: Context files now follow date-based naming convention

### Git Ignore Updates
- **Enhanced media file exclusion**: Updated .gitignore to comprehensively exclude all media files
- **Added file type coverage**: Now ignores jpg, jpeg, png, gif, bmp, webp, svg, ico, tiff, tif, raw, heic, heif
- **Protected key directories**: 
  - `assets/images/` - All card image assets
  - `input/*` - User input directory (except .gitkeep)
  - `output/ultra_cache/images/` - Cached images
  - `src/web/static/images/` - Web static images
  - `src/web/static/uploads/` - Web uploads
- **Preserved structure markers**: Maintains all .gitkeep files for empty directories

### Documentation Updates
- **DIRECTORY_STRUCTURE.md**: Documents the reorganized project structure
- **PROJECT_REORGANIZATION_SUMMARY.md**: Comprehensive summary of all reorganization changes
- **SCRIPT_ORGANIZATION_SUMMARY.md**: Details the new scripts directory structure

### API Loop and Crash Prevention Guidelines Added to CLAUDE.md
- **Detecting API Loops**: Guidelines for identifying repeated API calls, error patterns, infinite recursion, and missing break conditions
- **Breaking Out of Loops**: Implementation strategies including:
  - Retry limits with MAX_RETRIES pattern
  - Exponential backoff for rate limiting
  - Circuit breaker patterns for consecutive failures
- **Preventing Crashes**: Best practices for:
  - API response validation
  - Proper error handling with specific exceptions
  - Rate limit monitoring and throttling
- **Emergency Escape Strategies**: Procedures for when stuck in loops, unresponsive APIs, or repeated errors
- **Code Examples**: Practical Python code snippets for implementing retry logic and exponential backoff

## Recent Updates (November 11, 2025)

### Input Folder Migration Completed
- **Finalized transition from "Scans" to "input" folder**: All code references have been updated
- **Updated Docker configurations**: All docker-compose files now mount the `input` folder instead of `Scans`
- **Updated deployment scripts**: `deploy.sh` now creates and manages the `input` directory
- **Updated logging messages**: Main application logs now reference "input folder" for consistency
- **Created CLAUDE.md**: Added project-specific instructions for AI assistance, including sub-agent deployment guidelines

### Notes on the Migration:
- The configuration system already defaulted to "input" folder, making the transition smooth
- Internal variable names still use `scans_folder` for backward compatibility but correctly point to "input"
- The old "Scans" folder remains in the project but is no longer used
- All Docker volume mappings now consistently use `../../input:/app/input`

## Major Changes

### 1. Environment and Configuration Management
- **Created**: `.env.template` - Base template for environment variables
- **Created**: `.env.production.example` - Production-specific environment example
- **Removed**: Old `.env.example` file
- **Security**: Added comprehensive `.dockerignore` to prevent sensitive files from being included in Docker images

### 2. Database Architecture
- **Migrated to PostgreSQL**: Moved from SQLite to PostgreSQL for better scalability and performance
- **Added Alembic**: Database migration tool for version control of schema changes
- **New Files**:
  - `alembic.ini` - Alembic configuration
  - `alembic/` directory - Migration scripts
  - `src/database/migrations.py` - Migration utilities
  - `src/database/service.py` - Database service layer
  - `src/database/crud.py` - CRUD operations
  - `src/database/optimized_service.py` - Performance-optimized database operations

### 3. Docker Infrastructure
- **Created**: `Dockerfile` - Main application container
- **Created**: `docker-compose.yml` - Development environment
- **Created**: `docker-compose.production.yml` - Production environment
- **Created**: `docker/` directory with:
  - `nginx/nginx.conf` - Web server configuration
  - `scripts/entrypoint.sh` - Container initialization
  - `scripts/wait-for-it.sh` - Service dependency management

### 4. Testing Infrastructure
- **Created**: `pytest.ini` - Test configuration
- **Created**: `run_tests.py` - Test runner script
- **Created**: `tests/` directory structure for organized testing

### 5. Performance Improvements
- **Async Processing**: Added async versions of key components:
  - `src/async_cache.py` - Asynchronous caching
  - `src/processing/async_*.py` - Async image processing pipeline
  - `src/utils/rate_limiter.py` - API rate limiting
  - `src/utils/performance_monitor.py` - Performance tracking
  - `src/utils/http_session.py` - Optimized HTTP session management

### 6. Security Enhancements
- **Created**: `SECURITY.md` - Security policies and reporting
- **Created**: `verify_security.py` - Security verification script
- **Created**: `src/web/security_utils.py` - Web security utilities
- **Added**: Login system with `src/web/templates/login.html`

### 7. Japanese Card Support
- **Created**: Japanese card downloading and management tools:
  - `src/scrapers/japanese_card_downloader.py`
  - `src/scrapers/japanese_card_manager.py`
  - `src/scrapers/tcgdex_japanese_downloader.py`
  - `src/scrapers/tcgdex_japanese_downloader_english_names.py`
  - `japanese_pokemon_cards_complete/` directory for card data

### 8. Documentation Updates
- **Created**: `docs/MIGRATIONS.md` - Database migration guide
- **Cleaned Up**: Removed outdated documentation files
- **Updated**: Project structure documentation

### 9. Scripts and Automation
- **Created**: `scripts/` directory for maintenance and utility scripts
- **Created**: `scripts/database/migrate.py` - Database migration helper

## Files Removed During Cleanup

### Development and Test Files
- All files in `image_optimization_tests/` directory
- Old optimization scripts: `batch_optimize.py`, `optimize_images.py`
- Debug scripts: `analyze_finish_issues.py`, `debug_finish_flow.py`
- Setup verification: `check_setup.py`, `setup_project.py`

### Old Documentation
- `AUTOMATIC_OPTIMIZATION.md`
- `CLAUDE.md` (moved to project root as project instructions)
- `CONTEXT_SUMMARY_JULY_2025.md`
- `FINISH_DETECTION_FIXES.md`
- `IMAGE_OPTIMIZATION_REPORT.md`
- Duplicate documentation in `docs/` directory

### Debug Output
- All files in `output/ximilar_debug/` directory (100+ debug JSON files)

### Other
- `Bulk Buy List Calculator.xlsm` - Excel file moved to appropriate location
- `config.example.json` - Replaced with environment-based configuration

## Directory Structure Changes

### Empty Directories Removed
- `docs/api/`
- `assets/images/mtg/`
- `Scans/` - Replaced by `input/` directory

### Current Directory Structure
```
.
├── alembic/                    # Database migrations
├── assets/                     # Static assets
│   └── images/                 # Card images
│       ├── pokemon/            # Pokemon TCG images
│       │   ├── english/        # English card sets
│       │   └── japanese/       # Japanese card sets
│       └── mtg/                # Magic: The Gathering (future)
├── config/                     # Configuration files
│   ├── alembic.ini            # Alembic configuration
│   ├── pytest.ini             # Pytest configuration
│   └── docker/                # Docker configs
├── context/                    # Context management (NEW)
│   └── archive/               # Historical context files
├── docker/                     # Docker configuration
│   ├── nginx/                  # Nginx configuration
│   └── scripts/                # Container scripts
├── docs/                       # Documentation
│   ├── deployment/            # Deployment guides
│   ├── technical/             # Technical documentation
│   ├── testing/               # Testing documentation
│   └── user-guides/           # User documentation
├── input/                      # User input directory for scans
├── japanese_pokemon_cards_complete/  # Japanese card data
├── output/                     # Generated output
│   ├── manual_review/          # Manual review data
│   ├── scans/                  # Processed scans
│   └── ultra_cache/            # Cache storage
├── scripts/                    # Utility scripts
│   ├── database/              # Database scripts
│   ├── deployment/            # Deployment scripts
│   ├── development/           # Development tools
│   ├── docker/                # Docker scripts
│   └── maintenance/           # Maintenance scripts
├── src/                        # Source code
│   ├── api/                    # API integrations
│   ├── cache/                  # Caching utilities (deprecated)
│   ├── database/               # Database layer
│   ├── models/                 # Data models (deprecated)
│   ├── output/                 # Output formatting
│   ├── processing/             # Image and card processing
│   ├── scrapers/               # Web scrapers
│   ├── utils/                  # Utility functions
│   └── web/                    # Web interface
└── tests/                      # Test suite
```

## Configuration Updates

### .gitignore Updates
- Added patterns for new directories and file types
- Improved organization and comments
- Added Docker-specific exclusions
- Added security for environment files
- Comprehensive media file exclusion (July 12, 2025)

### Environment Variables
- Standardized naming conventions
- Separated development and production configurations
- Added comprehensive documentation in templates

## Important File Locations

### Configuration Files
- `.env` - Environment variables (create from `.env.template`)
- `.env.template` - Template for environment variables
- `.env.production.example` - Production environment example
- `alembic.ini` - Database migration configuration
- `pytest.ini` - Test configuration
- `docker-compose.yml` - Development Docker setup
- `docker-compose.production.yml` - Production Docker setup

### Main Application Files
- `src/main.py` - Main application entry point
- `src/web/app.py` - Web interface
- `src/config.py` - Application configuration
- `src/models.py` - Data models

### Key Processing Components
- `src/processing/card_identifier.py` - Card identification logic
- `src/processing/price_calculator.py` - Price calculation
- `src/processing/image_processor.py` - Image processing
- `src/processing/group_detector.py` - Multi-card detection

### API Integrations
- `src/api/ximilar.py` - Ximilar AI integration
- `src/api/pokemon_tcg.py` - Pokemon TCG API
- `src/api/ebay_eps.py` - eBay pricing data
- `src/api/scryfall.py` - MTG card data (future)

### Database Components
- `src/database/models.py` - SQLAlchemy models
- `src/database/service.py` - Database service layer
- `src/database/crud.py` - CRUD operations
- `alembic/versions/` - Database migrations

## Quick Start Guide

### Local Development Setup
1. **Clone the repository**
2. **Set up environment**:
   ```bash
   cp .env.template .env
   # Edit .env with your API keys and settings
   ```
3. **Install dependencies**:
   ```bash
   pip install -r requirements.txt
   pip install -r src/web/requirements.txt
   ```
4. **Set up database**:
   ```bash
   python scripts/database/migrate.py up
   ```
5. **Run the application**:
   ```bash
   python src/main.py  # For CLI mode
   python src/web/app.py  # For web interface
   ```

### Docker Setup
1. **Copy environment file**:
   ```bash
   cp .env.template .env
   # Edit .env with your settings
   ```
2. **Start services**:
   ```bash
   docker-compose up -d
   ```
3. **Access the application**:
   - Web interface: http://localhost:5000
   - API docs: http://localhost:5000/docs

## Next Steps

1. **Database Migration**: Run `python scripts/database/migrate.py` to set up the PostgreSQL database
2. **Docker Setup**: Use `docker-compose up` for development environment
3. **Security Verification**: Run `python scripts/maintenance/verify_security.py` to check security settings
4. **Testing**: Run `python scripts/development/run_tests.py` to ensure all functionality works

## Key Project Features

### Core Functionality
1. **Card Identification**: Automated identification of Pokemon TCG cards using:
   - Ximilar AI image recognition
   - Pokemon TCG API integration
   - Manual fallback options

2. **Price Calculation**: Multi-source pricing with:
   - TCGPlayer market prices
   - eBay sold listings analysis
   - Promo card special pricing logic
   - Automatic pricing adjustments based on condition

3. **Batch Processing**: Efficient processing of multiple cards with:
   - Group detection for multi-card scans
   - Automatic image optimization
   - Parallel processing capabilities

4. **Output Generation**: Multiple output formats:
   - Excel files for eBay bulk upload
   - HTML review pages for verification
   - Organized file structure for processed images

### Recent Major Updates

1. **Migration to PostgreSQL**:
   - Moved from SQLite to PostgreSQL for better performance
   - Added Alembic for database version control
   - Improved data integrity and concurrent access

2. **Docker Containerization**:
   - Full Docker support for development and production
   - Nginx reverse proxy configuration
   - Docker Compose for easy deployment

3. **Performance Enhancements**:
   - Async processing pipeline for image operations
   - HTTP session pooling for API calls
   - Rate limiting to prevent API throttling
   - Caching improvements

4. **Security Improvements**:
   - Environment-based configuration
   - Login system for web interface
   - Security verification scripts
   - Comprehensive .dockerignore

5. **Testing Framework**:
   - Pytest configuration
   - Organized test structure
   - Automated test runner

## Notes

- All core functionality has been preserved during reorganization
- Performance improvements through async processing are optional but recommended
- Docker deployment is now available but not required for local development
- Japanese card support is fully integrated but optional
- The project now follows industry best practices for structure and deployment
- Context management system implemented for better project documentation tracking (July 12, 2025)